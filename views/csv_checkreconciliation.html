% rebase('base.html', title="{} | Find that charity".format(file["name"]), heading=file["name"], subtitle="Reconciling on {}".format(file["reconcile_field"]) )
% include('csv_steps.html', step=3)
<div class="columns">
  <div class="column">
    <div class="content">
      <form method="post">
        <input type="hidden" id="file_id" value="{{fileid}}" />
        <p>Options needed</p>
        <ul>
          <li>Autoclassify based on score</li>
          <li>Pagination</li>
          <li>Preview</li>
          <li><s>Search for alternative (typeahead-style)</s></li>
          <li>Download results</li>
          <li>Change order (hardest ones first?)</li>
        </ul>
        <p>Options for each reconciliation block.</p>
        <ul>
          <li>Confirmed result: 
            <ul>
              <li>Option to reset to unconfirmed</li>
            </ul>
          </li>
          <li>
            Result matched:
            <ul>
              <li>Global confirm all matched results</li>
              <li>Option to confirm match</li>
              <li><s>Option to reset to unmatched</s></li>
            </ul>
          </li>
          <li>
            No matched results:
            <ul>
              <li>Global confirm the best match in all cases (or use filter/threshold)</li>
              <li><s>Select from list (change to confirmed match)</s></li>
              <li><s>Search for an alternative match with textbox (and change to confirmed match if found)</s></li>
              <li><s>Preview more info about the charity</s></li>
            </ul>
          </li>
        </ul>
        <div id="reconcile-root">
        <p>
          {{len(file["data"])}} rows in the file.
        </p>
        <table class="table is-striped is-narrow">
          <tr>
          % for h in file["fields"]:
            <th>
              {{h}}
            </th>
            % if "reconcile_results" in file and h == file["reconcile_field"]:
            <th>
              Select charity
            </th>
            % end
          % end
          </tr>
        % for k, r in enumerate(file["data"]): 
          <tr>
          % for c in file["fields"]:
            <td>{{r[c]}}</td>
            % if c == file["reconcile_field"]:
            % results = file["reconcile_results"][r[file["reconcile_field"]]]["result"]
            % import json
            % import urllib.parse
            <td class="reconcile-result">
              % if results:
              % hide_results = "is-hidden" if results[0]["match"] else ""
              % show_results = "" if results[0]["match"] else "is-hidden"
              <div class="{{show_results}} selected-result">
                % if results[0]["match"]:
                  <span class="tag is-success">Matched</span>
                  {{ results[0]["source"]["known_as"] }} 
                  (<a href="/charity/{{results[0]["id"]}}" target="_blank">{{results[0]["id"]}}</a>)
                  <span class="has-text-grey is-size-7">[<a href="#">Unmatch</a>]</span>
                % end
              </div>
              <div class="{{hide_results}} full-results">
              % for result in file["reconcile_results"][r[file["reconcile_field"]]]["result"]:
                <label class="is-size-6">
                  <input type="radio" class="reconcile_choice" name="reconcile_choice_{{k}}" value="{{result["id"]}}">
                    <!-- <code>{{ result }}</code> -->
                    % if not result["source"]["active"]:
                    <span class="has-text-grey">INACTIVE: {{result["source"]["known_as"]}}</span>
                    % else:
                    {{result["source"]["known_as"]}} 
                    % end
                    (<a href="/charity/{{result["id"]}}" target="_blank">{{result["id"]}}</a>)
                  <span class="has-text-grey is-size-7">[{{result["score"]}}]</span>
                </label>
                <br>
              % end
              </div>
              % end
            </td>
            % end
          % end
          </tr>
        % end
        </table>
        <div class="control">
          <input type="submit" value="Add charity numbers to the data" class="button is-link" />
        </div>
        </div>
      </form>
    </div>
  </div>
</div>
% import json
<script type="text/javascript">
const reconcile_data = {{ !json.dumps(file) }};
</script>